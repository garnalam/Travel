<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vietnam Travel</title>
    <script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for analytics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Enhanced Modern Admin Panel Styles */
        .admin-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .admin-sidebar {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
            position: relative;
            overflow: hidden;
        }
        
        .admin-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); }
        }
        
        .admin-content {
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            position: relative;
        }
        
        .setting-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .setting-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.8), transparent);
            transition: left 0.5s;
        }
        
        .setting-card:hover::before {
            left: 100%;
        }
        
        .setting-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .nav-item {
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            border-left: 4px solid #FFF;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .admin-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .admin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .admin-btn:hover::before {
            left: 100%;
        }
        
        .admin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .feature-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-indicator.saved {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3B82F6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <div class="flex min-h-screen">
        <!-- Enhanced Sidebar -->
        <div class="admin-sidebar w-72 p-8 text-white relative z-10">
            <div class="mb-10">
                <div class="flex items-center space-x-4 mb-3">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-lg">
                        <i class="fas fa-cogs text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold" data-en="Admin Panel" data-vi="Bảng Điều Khiển Admin">Admin Panel</h1>
                        <p class="text-sm opacity-80" data-en="System Configuration" data-vi="Cấu Hình Hệ Thống">System Configuration</p>
                    </div>
                </div>
                <div class="status-indicator saved">
                    <i class="fas fa-circle text-green-400 mr-2"></i>
                    <span id="saveStatus" data-en="System Ready" data-vi="Hệ Thống Sẵn Sàng">Hệ Thống Sẵn Sàng</span>
                </div>
            </div>
            
            <nav class="space-y-2">
                <a href="#users" class="nav-item active flex items-center space-x-4 p-4 rounded-xl transition">
                    <i class="fas fa-users text-xl"></i>
                    <span data-en="User Management" data-vi="Quản Lý Người Dùng">Quản Lý Người Dùng</span>
                </a>
                <a href="#analysis" class="nav-item flex items-center space-x-4 p-4 rounded-xl transition">
                    <i class="fas fa-chart-bar text-xl"></i>
                    <span data-en="Analytics" data-vi="Phân Tích">Phân Tích</span>
                </a>
                <hr class="border-white/30 my-6">
                <a href="dashboard.html" class="nav-item flex items-center space-x-4 p-4 rounded-xl transition text-yellow-200 hover:text-white">
                    <i class="fas fa-arrow-left text-xl"></i>
                    <span data-en="Back to Dashboard" data-vi="Quay Lại Dashboard">Quay Lại Dashboard</span>
                </a>
            </nav>
        </div>
        
        <!-- Enhanced Main Content -->
        <div class="admin-content flex-1 p-8">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 gap-8">
                    <!-- User Management Section -->
                    <div id="userSection" class="setting-card p-8">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2" data-en="User Management" data-vi="Quản Lý Người Dùng">Quản Lý Người Dùng</h3>
                        <p class="text-gray-600 mb-6" data-en="Manage users, roles and permissions" data-vi="Quản lý người dùng, quyền hạn và vai trò">Quản lý người dùng, quyền hạn và vai trò</p>
                        
                        <!-- User Search and Filters -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <input type="text" id="userSearch" placeholder="Tìm kiếm theo tên, email..." 
                                       class="w-full p-3 border rounded-xl">
                            </div>
                            <div>
                                <select id="roleFilter" class="w-full p-3 border rounded-xl bg-white">
                                    <option value="">Tất cả vai trò</option>
                                    <option value="1">Admin</option>
                                    <option value="0">User thường</option>
                                </select>
                            </div>
                            <div>
                                <button id="refreshUsers" class="admin-btn w-full">
                                    <i class="fas fa-sync-alt mr-2"></i>Làm mới
                                </button>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="bg-white rounded-xl border overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b">
                                <h4 class="font-semibold text-gray-800">Danh Sách Người Dùng</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="usersTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left p-4 font-semibold text-gray-700">ID</th>
                                            <th class="text-left p-4 font-semibold text-gray-700">Họ Tên</th>
                                            <th class="text-left p-4 font-semibold text-gray-700">Email</th>
                                            <th class="text-left p-4 font-semibold text-gray-700">Số ĐT</th>
                                            <th class="text-left p-4 font-semibold text-gray-700">Vai Trò</th>
                                            <th class="text-left p-4 font-semibold text-gray-700">Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center p-8">
                                                <div class="loading-spinner mx-auto mb-2"></div>
                                                <p class="text-gray-500">Đang tải dữ liệu...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div class="flex justify-between items-center mt-6">
                            <div class="text-sm text-gray-600">
                                <span id="userPaginationInfo">Hiển thị 0 - 0 của 0 người dùng</span>
                            </div>
                            <div class="flex space-x-2" id="userPagination">
                                <button class="px-3 py-2 border rounded-lg text-gray-600 hover:bg-gray-50" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="px-3 py-2 border rounded-lg bg-blue-500 text-white">1</button>
                                <button class="px-3 py-2 border rounded-lg text-gray-600 hover:bg-gray-50" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Section -->
                    <div id="analysisSection" class="setting-card p-8 hidden">
                        <div class="feature-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2" data-en="Analytics" data-vi="Phân Tích">Phân Tích Dữ Liệu</h3>
                        <p class="text-gray-600 mb-6" data-en="Analytics and reporting dashboard" data-vi="Bảng điều khiển phân tích và báo cáo">Bảng điều khiển phân tích và báo cáo dựa trên dữ liệu thực</p>
                        
                        <!-- Analytics Dashboard -->
                        <div class="space-y-8">
                            <!-- Tour Statistics Section with Filters -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="text-xl font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-route mr-3 text-green-600"></i>
                                        Thống Kê Tour
                                    </h4>
                                    <button onclick="loadTourStatistics()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-sync-alt mr-2"></i>Làm mới
                                    </button>
                                </div>
                                
                                <!-- Filters Section -->
                                <div class="filter-section">
                                    <h5 class="font-semibold text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-filter mr-2"></i>Bộ Lọc
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Quốc gia</label>
                                            <select id="tourCountryFilter" class="w-full p-3 border rounded-xl bg-white">
                                                <option value="">Tất cả quốc gia</option>
                                                <!-- Dropdown sẽ được điền động bằng dữ liệu từ database -->
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Mức giá (USD)</label>
                                            <select id="tourPriceFilter" class="w-full p-3 border rounded-xl bg-white">
                                                <option value="">Tất cả mức giá</option>
                                                <option value="0-500">$0 - $500</option>
                                                <option value="500-1000">$500 - $1,000</option>
                                                <option value="1000-2000">$1,000 - $2,000</option>
                                                <option value="2000-5000">$2,000 - $5,000</option>
                                                <option value="5000+">$5,000+</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Thao tác</label>
                                            <button onclick="applyTourFilters()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                                                <i class="fas fa-search mr-2"></i>Áp dụng lọc
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600" id="totalTours">-</div>
                                        <div class="text-sm text-gray-600">Tổng tour</div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600" id="totalOptions">-</div>
                                        <div class="text-sm text-gray-600">Tổng tùy chọn tour</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600" id="avgCost">-</div>
                                        <div class="text-sm text-gray-600">Chi phí tour trung bình</div>
                                    </div>
                                </div>
                                
                                <!-- Top Cities Chart -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-gray-700 mb-3">Top 5 Thành Phố Phổ Biến</h5>
                                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                                            <canvas id="topCitiesChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-gray-700 mb-3">Phân Bố Chi Phí Tour</h5>
                                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                                            <canvas id="costDistributionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Activity & Destination Stats -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="text-xl font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-map-marked-alt mr-3 text-purple-600"></i>
                                        Hoạt Động & Điểm Đến
                                    </h4>
                                    <button onclick="loadActivityStats()" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                        <i class="fas fa-sync-alt mr-2"></i>Làm mới
                                    </button>
                                </div>
                                
                                <!-- Activity Filters Section -->
                                <div class="filter-section">
                                    <h5 class="font-semibold text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-filter mr-2"></i>Bộ Lọc Hoạt Động
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Quốc gia</label>
                                            <select id="activityCountryFilter" class="w-full p-3 border rounded-xl bg-white">
                                                <option value="">Tất cả quốc gia</option>
                                                <!-- Dropdown sẽ được điền động bằng dữ liệu từ database -->
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Mức giá (USD)</label>
                                            <select id="activityPriceFilter" class="w-full p-3 border rounded-xl bg-white">
                                                <option value="">Tất cả mức giá</option>
                                                <option value="0-50">$0 - $50</option>
                                                <option value="50-100">$50 - $100</option>
                                                <option value="100-200">$100 - $200</option>
                                                <option value="200+">$200+</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Thao tác</label>
                                            <button onclick="applyActivityFilters()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors">
                                                <i class="fas fa-search mr-2"></i>Áp dụng lọc
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600" id="totalActivities">-</div>
                                        <div class="text-sm text-gray-600">Tổng hoạt động</div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600" id="totalCities">-</div>
                                        <div class="text-sm text-gray-600">Tổng thành phố</div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600" id="avgRating">-</div>
                                        <div class="text-sm text-gray-600">Đánh giá trung bình</div>
                                    </div>
                                </div>
                                
                                <!-- Activity Type & Rating Charts -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-gray-700 mb-3">Phân Bố Loại Hoạt Động</h5>
                                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                                            <canvas id="activityTypeChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-gray-700 mb-3">Top 5 Hoạt Động Được Đánh Giá Cao Nhất</h5>
                                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                                            <canvas id="topRatedActivitiesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ENHANCED ADMIN PANEL JAVASCRIPT ====================
        
        // Charts storage
        const charts = {};
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'info' ? 'bg-blue-500 text-white' :
                'bg-yellow-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-circle' : 
                        type === 'info' ? 'info-circle' :
                        'exclamation-triangle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ==================== NAVIGATION SYSTEM ====================
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (this.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    
                    // Update active nav
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show/hide sections
                    const targetSection = this.getAttribute('href').substring(1);
                    showSection(targetSection);
                }
            });
        });
        
        function showSection(sectionName) {
            // Hide all sections
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('analysisSection').classList.add('hidden');
            
            // Show target section
            switch(sectionName) {
                case 'users':
                    document.getElementById('userSection').classList.remove('hidden');
                    loadUsers();
                    break;
                case 'analysis':
                    document.getElementById('analysisSection').classList.remove('hidden');
                    loadAllAnalytics();
                    break;
                default:
                    document.getElementById('userSection').classList.remove('hidden');
                    loadUsers();
            }
        }
        
        // ==================== USER MANAGEMENT ====================
        
        let currentUserPage = 1;
        let currentUsers = [];
        
        async function loadUsers(page = 1, search = '', roleFilter = '') {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 10,
                    search: search,
                    role: roleFilter
                });
                
                const response = await fetch(`/api/admin/users?${params}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách người dùng');
                }
                
                const result = await response.json();
                if (result.success) {
                    currentUsers = result.users;
                    currentUserPage = page;
                    displayUsers(result.users);
                    updateUserPagination(result.pagination);
                } else {
                    throw new Error(result.message || 'Lỗi khi tải người dùng');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification(error.message, 'error');
                
                // Show error in table
                document.getElementById('userTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center p-8">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                            <p class="text-red-600">${error.message}</p>
                            <button onclick="loadUsers()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Thử lại
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center p-8">
                            <i class="fas fa-users text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Không có người dùng nào</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4">${user.user_id}</td>
                    <td class="p-4">
                        <div class="font-medium text-gray-800">${user.name || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${user.city || ''}, ${user.country || ''}</div>
                    </td>
                    <td class="p-4">${user.email}</td>
                    <td class="p-4">${user.phone_number || 'N/A'}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'
                        }">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex space-x-2">
                            <button onclick="editUser('${user.user_id}')" 
                                    class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                <i class="fas fa-edit mr-1"></i>Sửa
                            </button>
                            <button onclick="deleteUser('${user.user_id}', '${user.name}')" 
                                    class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                <i class="fas fa-trash mr-1"></i>Xóa
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateUserPagination(pagination) {
            const info = document.getElementById('userPaginationInfo');
            const paginationDiv = document.getElementById('userPagination');
            
            const start = (pagination.current_page - 1) * pagination.limit + 1;
            const end = Math.min(start + pagination.limit - 1, pagination.total_users);
            
            info.textContent = `Hiển thị ${start} - ${end} của ${pagination.total_users} người dùng`;
            
            // Generate pagination buttons
            let paginationHTML = '';
            
            if (pagination.current_page > 1) {
                paginationHTML += `
                    <button onclick="loadUsers(${pagination.current_page - 1}, getCurrentSearch(), getCurrentRoleFilter())" 
                            class="px-3 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
            }
            
            const startPage = Math.max(1, pagination.current_page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="loadUsers(${i}, getCurrentSearch(), getCurrentRoleFilter())" 
                            class="px-3 py-2 border rounded-lg ${
                                i === pagination.current_page 
                                    ? 'bg-blue-500 text-white' 
                                    : 'text-gray-600 hover:bg-gray-50'
                            }">
                        ${i}
                    </button>
                `;
            }
            
            if (pagination.current_page < pagination.total_pages) {
                paginationHTML += `
                    <button onclick="loadUsers(${pagination.current_page + 1}, getCurrentSearch(), getCurrentRoleFilter())" 
                            class="px-3 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }
            
            paginationDiv.innerHTML = paginationHTML;
        }
        
        function getCurrentSearch() {
            return document.getElementById('userSearch').value.trim();
        }
        
        function getCurrentRoleFilter() {
            return document.getElementById('roleFilter').value;
        }
        
        function editUser(userId) {
            alert(`Chức năng chỉnh sửa user ${userId} - sẽ được triển khai sau`);
        }
        
        function deleteUser(userId, userName) {
            if (confirm(`Bạn có chắc muốn xóa người dùng "${userName}"?`)) {
                alert(`Chức năng xóa user ${userId} - sẽ được triển khai sau`);
            }
        }
        
        // User Management Event Listeners
        document.getElementById('userSearch').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                loadUsers(1, this.value.trim(), getCurrentRoleFilter());
            }, 500);
        });
        
        document.getElementById('roleFilter').addEventListener('change', function() {
            loadUsers(1, getCurrentSearch(), this.value);
        });
        
        document.getElementById('refreshUsers').addEventListener('click', function() {
            loadUsers(currentUserPage, getCurrentSearch(), getCurrentRoleFilter());
        });
        
        // ==================== ANALYTICS FUNCTIONS ====================
        
        async function loadTourStatistics(country = '', price = '') {
            console.log('Loading tour statistics from database...', { country, price });
            
            try {
                // Tạo query parameters từ các filters
                const params = new URLSearchParams();
                if (country) params.append('country', country);
                if (price) params.append('price', price);
                
                const url = `/api/admin/analytics/tours${params.toString() ? '?' + params.toString() : ''}`;
                console.log('Fetching URL:', url);
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load tour statistics');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Cập nhật metrics
                    document.getElementById('totalTours').textContent = data.total_tours.toLocaleString();
                    document.getElementById('totalOptions').textContent = data.total_options.toLocaleString();
                    document.getElementById('avgCost').textContent = `$${data.avg_cost.toLocaleString()}`;
                    
                    // Cập nhật biểu đồ
                    if (data.top_cities && data.top_cities.length > 0) {
                        createTopCitiesChart(data.top_cities);
                    } else {
                        // Nếu không có dữ liệu, hiển thị biểu đồ trống
                        createTopCitiesChart([]);
                    }
                    
                    if (data.cost_distribution) {
                        createCostDistributionChart(data.cost_distribution);
                    } else {
                        // Nếu không có dữ liệu, hiển thị biểu đồ trống
                        createCostDistributionChart([]);
                    }
                    
                    // Điền các quốc gia vào dropdown từ dữ liệu API
                    if (data.countries && data.countries.length > 0) {
                        populateCountryDropdown(data.countries);
                    }
                    
                    console.log('✅ Tour statistics loaded successfully');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('❌ Error loading tour statistics:', error);
                document.getElementById('totalTours').textContent = '0';
                document.getElementById('totalOptions').textContent = '0';
                document.getElementById('avgCost').textContent = '$0';
                // Reset biểu đồ khi có lỗi
                createTopCitiesChart([]);
                createCostDistributionChart([]);
            }
        }
        
        // Hàm điền danh sách quốc gia vào dropdown
        function populateCountryDropdown(countries) {
            const dropdown = document.getElementById('tourCountryFilter');
            // Lưu lại giá trị đã chọn trước đó
            const selectedValue = dropdown.value;
            
            // Xóa tất cả options trừ option đầu tiên (Tất cả quốc gia)
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Thêm các quốc gia từ dữ liệu API
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                dropdown.appendChild(option);
            });
            
            // Khôi phục giá trị đã chọn
            if (selectedValue && countries.includes(selectedValue)) {
                dropdown.value = selectedValue;
            }
        }
        
        async function loadActivityStats(country = '', price = '') {
            console.log('Loading activity statistics from database...', { country, price });
            
            try {
                // Tạo query parameters từ các filters
                const params = new URLSearchParams();
                if (country) params.append('country', country);
                if (price) params.append('price', price);
                
                const url = `/api/admin/analytics/activities${params.toString() ? '?' + params.toString() : ''}`;
                console.log('Fetching URL:', url);
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load activity statistics');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Cập nhật metrics
                    document.getElementById('totalActivities').textContent = data.total_activities.toLocaleString();
                    document.getElementById('totalCities').textContent = data.total_cities.toLocaleString();
                    document.getElementById('avgRating').textContent = `${data.avg_rating}/10`;
                    
                    // Cập nhật biểu đồ
                    if (data.activity_types && data.activity_types.length > 0) {
                        createActivityTypeChart(data.activity_types);
                    } else {
                        // Nếu không có dữ liệu, hiển thị biểu đồ trống
                        createActivityTypeChart([]);
                    }
                    
                    if (data.top_rated && data.top_rated.length > 0) {
                        createTopRatedActivitiesChart(data.top_rated);
                    } else {
                        // Nếu không có dữ liệu, hiển thị biểu đồ trống
                        createTopRatedActivitiesChart([]);
                    }
                    
                    // Điền các quốc gia vào dropdown từ dữ liệu API
                    if (data.countries && data.countries.length > 0) {
                        populateActivityCountryDropdown(data.countries);
                    }
                    
                    console.log('✅ Activity statistics loaded successfully');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('❌ Error loading activity statistics:', error);
                document.getElementById('totalActivities').textContent = '0';
                document.getElementById('totalCities').textContent = '0';
                document.getElementById('avgRating').textContent = '0.0/10';
                // Reset biểu đồ khi có lỗi
                createActivityTypeChart([]);
                createTopRatedActivitiesChart([]);
            }
        }
        
        // Hàm điền danh sách quốc gia vào dropdown cho activity
        function populateActivityCountryDropdown(countries) {
            const dropdown = document.getElementById('activityCountryFilter');
            // Lưu lại giá trị đã chọn trước đó
            const selectedValue = dropdown.value;
            
            // Xóa tất cả options trừ option đầu tiên (Tất cả quốc gia)
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Thêm các quốc gia từ dữ liệu API
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                dropdown.appendChild(option);
            });
            
            // Khôi phục giá trị đã chọn
            if (selectedValue && countries.includes(selectedValue)) {
                dropdown.value = selectedValue;
            }
        }
        
        function loadAllAnalytics() {
            console.log('Loading all analytics data...');
            loadTourStatistics();
            loadActivityStats();
        }
        
        // ==================== CHART FUNCTIONS ====================
        
        function createTopCitiesChart(topCities) {
            const ctx = document.getElementById('topCitiesChart');
            if (!ctx) return;
            
            if (charts.topCities) {
                charts.topCities.destroy();
            }
            
            const labels = topCities.map(city => city.city_name);
            const data = topCities.map(city => city.tour_count);
            
            charts.topCities = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số tour',
                        data: data,
                        backgroundColor: '#10B981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createCostDistributionChart(costDistribution = []) {
            const ctx = document.getElementById('costDistributionChart');
            if (!ctx) return;
            
            if (charts.costDistribution) {
                charts.costDistribution.destroy();
            }
            
            // Process cost distribution data
            const labels = ['<$500', '$500-1000', '$1000-2000', '$2000-5000', '>$5000'];
            const data = [0, 0, 0, 0, 0];
            
            costDistribution.forEach(item => {
                const index = labels.indexOf(item.cost_range);
                if (index !== -1) {
                    data[index] = item.count;
                }
            });
            
            charts.costDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng tour',
                        data: data,
                        backgroundColor: '#3B82F6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createActivityTypeChart(activityTypes) {
            const ctx = document.getElementById('activityTypeChart');
            if (!ctx) return;
            
            if (charts.activityType) {
                charts.activityType.destroy();
            }
            
            const labels = activityTypes.map(type => type.type);
            const data = activityTypes.map(type => type.count);
            
            charts.activityType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                            '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function createTopRatedActivitiesChart(topRated) {
            const ctx = document.getElementById('topRatedActivitiesChart');
            if (!ctx) return;
            
            if (charts.topRated) {
                charts.topRated.destroy();
            }
            
            const labels = topRated.map(activity => activity.name.substring(0, 20) + '...');
            const data = topRated.map(activity => activity.rating);
            
            charts.topRated = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rating',
                        data: data,
                        backgroundColor: '#8B5CF6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }
        
        // ==================== FILTER FUNCTIONS ====================
        
        function applyTourFilters() {
            const country = document.getElementById('tourCountryFilter').value;
            const price = document.getElementById('tourPriceFilter').value;
            
            console.log('Applying tour filters:', { country, price });
            showNotification('Đang áp dụng bộ lọc tour...', 'info');
            
            // Gọi API với các tham số filter
            loadTourStatistics(country, price);
        }
        
        function applyActivityFilters() {
            const country = document.getElementById('activityCountryFilter').value;
            const price = document.getElementById('activityPriceFilter').value;
            
            console.log('Applying activity filters:', { country, price });
            showNotification('Đang áp dụng bộ lọc hoạt động...', 'info');
            
            // Gọi API với các tham số filter
            loadActivityStats(country, price);
        }
        
        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loaded - initializing...');
            
            // Check admin access
            fetch('/api/check-admin', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.is_admin) {
                    window.location.href = '/';
                    return;
                }
                
                // Load default section
                loadUsers();
            })
            .catch(error => {
                console.error('Admin check failed:', error);
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>